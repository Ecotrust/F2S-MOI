{% load nvd3_tags static compress wagtailcore_tags %}
<head>
    {% include_chart_jscss %}
</head>
<body>
    <div class="{{ data.chartcontainer }}">
        <svg></svg>
        {% if data.charttype == 'pie' %}
            <div class="pie-legend">
                {% for entry in data.chartdata|dictsortreversed:"value"  %}
                  <div class="{{ entry.value }}">
                    <i class="fa fa-circle {{ forloop.counter0 }}"
                       aria-hidden="true"
                       >
                    </i>
                    {{ entry.label }}
                  </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
<script>
var data = [{"values":  {{ data.chartdata | safe }} }];

if ('{{ data.charttype }}' === 'pie') {
    var datum = data[0].values;
} else {
    var datum = data;
}

var colorArrays = [
    //environment
    ['#ba2226', '#ae6054', '#c08477', '#d6aea3', '#e6d1ca'],
    //education
    ['#185377', '#5e7493', '#98a2b8', '#aeb5c6', '#d1d4de'],
    //health
    ['#f6ab1b', '#f9ba43', '#fbca7a', '#fddaa2', '#feeacd'],
    //economy
    ['#83b841', '#9bc261', '#b2ce87', '#cbdcab', '#e9f0dc']
];

function sectorColor() {
    switch('{{ request.path }}') {
        case '/environment/':
            sector = colorArrays[0];
            break;
        case '/education/':
            sector = colorArrays[1];
            break;
        case '/health/':
            sector = colorArrays[2];
            break;
        case '/economy/':
            sector = colorArrays[3];
            break;
    }
    return sector
}

d3.selectAll('.fa-circle').each(function(d,i) {
    d3.select(this).style('color', sectorColor()[i])
})

nv.addGraph(function() {
    var chart = nv.models.{{ data.charttype}}Chart()
        .x(function(d) { return d.label })
        .y(function(d) { return d.value })
        .color(sectorColor())

    var width = d3.select('.{{ data.chartcontainer }}').node().getBoundingClientRect().width
    var height = d3.select('.{{ data.chartcontainer }}').node().getBoundingClientRect().height

    //pie-donut
    if ('{{ data.charttype }}' === 'pie') {
        chart.tooltipContent(function(key, y, e, graph) {
            var x = String(key);
            var y =  String(y.slice(0,2));
            tooltip_str = '<center><b>'+y+'%</b></center>' + x;
            return tooltip_str;
        });

        chart.showLegend(false)
            .showLabels(false)
            .donut(true)
            .donutRatio(0.35)

    //barchart
    } else {
        chart.stacked(true)
            .showControls(false)
            .showLegend(false)
            .showValues(true)
            .margin({top: 30, right: 20, bottom: 50, left: 175});

        chart.yAxis
            .tickFormat(d3.format('.2'));
    }

    d3.select('.{{ data.chartcontainer }} svg')
        .attr("width", '100%')
        .attr("height", '100%')
        .attr('viewBox','0 0 '+width+' '+height)
        .attr('preserveAspectRatio','xMinYMin')
        .attr("transform", "translate(" + Math.min(width,height) / 2 + "," + Math.min(width,height) / 2 + ")")
        .datum(datum)
        .transition().duration(500)
        .call(chart);

    return chart;
});
</script>
</body>
